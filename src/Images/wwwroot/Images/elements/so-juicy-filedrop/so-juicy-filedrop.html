<link rel="import" href="/sys/paper-dialog/paper-dialog.html" />
<link rel="import" href="juicy-filedrop.html" />

<dom-module id="so-juicy-filedrop">
    <link rel="import" type="css" href="/sys/bootswatch/paper/bootstrap.css" />
    <template>
        <style>
            :host {
                display:block;
                height:100%;
                position:relative;
            }

            .container {
                height: 100%;
                width: 100%;
                padding: 0px;
                margin: 0px;
            }

            juicy-filedrop {
                display: block;
                overflow: hidden;
                color: rgb(170, 170, 170);
                border: 0px solid black;
                border: 0px solid #ccc;
                border-radius: 3px;
                height: 100%;
            }

            .drop-file-here {
                border-style: dashed;
                border-color: #A5A5A5;
                background: #EDEDED;
                border-width: 6px;
                height: 100%;
                width: 100%;
                max-height: 100%;
                max-width: 100%;
                text-align: center;
                box-sizing: border-box;
                display:table;
                overflow:hidden;
            }

            .drop-file-here .td {
                display:table-cell;
                vertical-align:middle;
            }

            .img-thumbnail {
                min-height: 50px;
                min-width: 50px;
                height: 100%;
                width: 100%;
                background-size: contain;
                background-position: center center;
                background-repeat: no-repeat;
            }

            .img-border {
                box-sizing: border-box;
                width: 100%;
                height: 100%;
                padding: 4px;
                background-color: #ffffff;
                border: 1px solid #dddddd;
                border-radius: 3px;
            }

            .video-preview {
                min-width:320px;
                min-height:240px;
                height: 100%;
                width: 100%;
                text-align:center;
            }

            .actions {
                position: absolute;
                right: 4px;
                top: 4px;
                display: none;
            }

            .container:hover .actions {
                display: block;
            }
            .glyphicon-spin {
                margin: 10px;
                font-size: 24pt;
                -webkit-animation: spin 1000ms infinite linear;
                animation: spin 1000ms infinite linear;
            }
            @-webkit-keyframes spin {
                0% {
                    -webkit-transform: rotate(0deg);
                    transform: rotate(0deg);
                }
                100% {
                    -webkit-transform: rotate(359deg);
                    transform: rotate(359deg);
                }
            }
            @keyframes spin {
                0% {
                    -webkit-transform: rotate(0deg);
                    transform: rotate(0deg);
                }
                100% {
                    -webkit-transform: rotate(359deg);
                    transform: rotate(359deg);
                }
            }
        </style>
        <div class="container">
            <juicy-filedrop url="{{uploadUrl}}" sessionId="{{sessionId}}" value="{{value}}" filetype="{{filetype}}" maxfilesize="{{maxFileSize}}" allowedmimetypes="{{allowedMimeTypes}}" progress="{{progress}}" id="jfFileDrop">
                <template is="dom-if" if="{{progress}}">
                    <div class="drop-file-here">
                        <div class="tr">
                            <span class="glyphicon glyphicon-refresh glyphicon-spin"></span>
                        </div>
                        <div class="tr" style="margin-bottom: 10px">
                            <span>Progress</span>
                            <span>{{progress}}</span>
                            <span>%</span>
                        </div>
                    </div>
                </template>

                <template is="dom-if" if="{{!progress}}">
                    <template is="dom-if" if="{{value}}">
                        <template is="dom-if" if="{{isVideo}}" restamp="true">
                            <div class="img-border">
                                <div class="video-preview">
                                    <video controls>
                                        <source src="{{value}}" type="{{filetype}}">
                                        Your browser does not support the video tag for file type
                                        <span>{{filetype}}</span>.
                                    </video>
                                </div>
                            </div>
                        </template>
                        <template is="dom-if" if="{{!isVideo}}" restamp="true">
                            <template is="dom-if" if="{{isImage}}">
                                <div class="img-border">
                                    <div class="img-thumbnail" style$="{{getImageStyle(value)}}"></div>
                                </div>
                            </template>
                            <template is="dom-if" if="{{!isImage}}">
                                <div class="img-border">
                                    <div class="img-thumbnail" style$="{{getFileStyle()}}"></div>
                                </div>
                            </template>
                        </template>
                    </template>
                    <template is="dom-if" if="{{!value}}">
                        <div class="drop-file-here">
                            <div class="td">
                                <span>Drop image here</span>
                                <br />
                                <a href="javascript:" on-click="openFile">Or select file</a>
                            </div>
                        </div>
                    </template>
                </template>
            </juicy-filedrop>
            <paper-dialog modal="true" backdrop="true" layered="true" role="dialog" id="pacAlertDialog">
                <div>
                    <h2>Error</h2>
                    <p>{{AlertMessage}}</p>
                </div>
                <div class="buttons">
                    <button class="btn btn-sm btn-default" affirmative role="button" tabindex="1" on-click="closeAlert">Close</button>
                </div>
            </paper-dialog>
            <div class="actions">
                <content id="content"></content>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: "so-juicy-filedrop",
            properties: {
                uploadUrl: { type: String },
                value: { type: String, notify: true },
                filetype: { type: String, notify: true, observer: "fileTypeChanged" },
                isVideo: { type: Boolean, notify: true },
                isImage: { type: Boolean, notify: true },
                progress: { type: Number, notify: true, value: 0 },
                sessionId: { type: String },
                maxFileSize: { type: Number },
                allowedMimeTypes: { type: Array, value: [] },
                openClick: { type: Number, value: 0, observer: "openClickChanged" },
                alertMessage: { type: String }
            },
            isDomReady: false,
            ready: function () {
                var that = this;

                this.isDomReady = true;

                this.$.jfFileDrop.addEventListener("fileUploading", function (e) {
                });

                this.$.jfFileDrop.addEventListener("fileUploaded", function (e) {
                });

                this.$.jfFileDrop.addEventListener("fileUploadError", function (e) {
                    that.openAlert(e.detail.statusText);
                });

                this.$.jfFileDrop.addEventListener("fileSelectError", function (e) {
                    that.openAlert(e.detail.message);
                });

                this.$.jfFileDrop.addEventListener("statechange", function (e) {
                });
            },
            openFile: function () {
                this.$.jfFileDrop.openFile();
            },
            openAlert: function (message) {
                this.AlertMessage = message;
                this.$.pacAlertDialog.opened = true;
            },
            closeAlert: function () {
                this.AlertMessage = "";
                this.$.pacAlertDialog.opened = false;
            },
            openClickChanged: function (newVal) {
                if (newVal > 0) {
                    //in IE and Edge, openClickChanged gets incorrectly called on page load, changing openClick value from "undefined" to 0
                    //this caused https://github.com/StarcounterSamples/Images/issues/23
                    this.openFile();
                }
            },
            getImageStyle: function (url) {
                return "background-image:url('" + url + "')";
            },
            getFileStyle: function () {
                return "background-image:url('/images/css/file_preview.png')";
            },
            fileTypeChanged: function (newVal) {
                this.isVideo = /video\//gi.test(newVal);
                this.isImage = /image\//gi.test(newVal);
            }
        });
    </script>
</dom-module>