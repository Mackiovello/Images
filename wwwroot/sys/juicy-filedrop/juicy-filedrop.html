<!--
Copyright 2015 Smörgåsbord Development. All rights reserved.
-->
<link rel="import" href="/sys/polymer/polymer.html">
<link rel="import" href="/sys/core-ajax/core-ajax.html">

<polymer-element name="juicy-filedrop" attributes="url customheader value openclick maxfilesize">
    <template>
        <style>
            :host {
                display: -webkit-box;
                display: -moz-box;
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
            }

            input[type=file] {
                display:none;
            }
        </style>
        <core-ajax id="postMedia" method="POST" url="{{url}}" on-core-response="{{handleResponse}}" on-core-error="{{handleError}}"></core-ajax>
        <input type="file" id="txtUploadFile" />
        <content id="content"></content>
    </template>
    <script>
        "use strict";
        Polymer('juicy-filedrop', {
            url: "",
            customheader: "x-file",
            ready: function () {
                this.setupDrop();
                this.setupSelect();

                if (!this.maxfilesize) {
                    this.maxfilesize = 512;
                }
            },
            openclickChanged: function () {
                console.log("openChanged");
                this.openFile();
            },
            checkFile: function (file) {
                if (file.size > this.maxfilesize) {
                    alert("File " + file.name + " is too big. Maximum file size is: " + (this.maxfilesize / 1024) + "kb.");
                    return false;
                }

                return true;
            },
            openFile: function () {
                var element = this.$.txtUploadFile;
                var ev;

                if (document.createEvent) {
                    ev = document.createEvent("MouseEvents");
                    ev.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 2, null);
                    element.dispatchEvent(ev);
                } else {
                    ev = document.createEventObject();
                    ev.button = 2;
                    element.fireEvent('onclick', ev);
                }
            },
            readData: function (file) {
                var postMedia = this.$.postMedia;
                var customheader = this.customheader;
                var reader = new FileReader();

                reader.onload = function (event) {
                    // POST Image to server
                    postMedia.headers = {};
                    postMedia.headers[customheader] = JSON.stringify(this.xFile);
                    postMedia.xFile = this.xFile;
                    postMedia.body = event.target.result;
                    postMedia.go();
                };

                reader.xFile = { type: file.type, name: file.name };
                this.fire('fileUploading', reader.xFile);
                reader.readAsDataURL(file);
            },
            setupSelect: function () {
                var onFileSelected = function (e) {
                    var files = e.target.files;

                    for (var i = 0; i < files.length; i++) {
                        var file = files[i];

                        if (!this.checkFile(file)) {
                            continue;
                        }

                        this.readData(files[i]);
                    }
                };

                this.$.txtUploadFile.addEventListener("change", onFileSelected.bind(this), false);
            },
            setupDrop: function () {
                var postMedia = this.$.postMedia;
                var customheader = this.customheader;

                if (typeof window.FileReader === 'undefined') {
                    // TODO: Browser does not support 'FileReader'
                }

                this.onpaste = function (event) {
                    var items = event.clipboardData.items;

                    for (var i = 0, item ; item = event.clipboardData.items[i]; i++) {
                        if (item.kind == "file") {
                            var blob = item.getAsFile();
                            
                            this.readData(blob);
                        }
                    }
                };

                this.ondragleave = function () {
                    if (this.classList.contains("hover")) {
                        this.classList.remove("hover");
                    }
                };

                this.ondragover = function (e) {
                    e.stopPropagation();

                    if (!this.classList.contains("hover")) {
                        this.classList.add("hover");
                    }

                    return false;
                };

                this.ondragend = function () {
                    if (this.classList.contains("hover")) {
                        this.classList.remove("hover");
                    }

                    return false;
                };

                this.ondrop = function (e) {
                    if (this.classList.contains("hover")) {
                        this.classList.remove("hover");
                    }

                    e.preventDefault();

                    for (var i = 0, file; file = e.dataTransfer.files[i]; i++) {
                        if (!this.checkFile(file)) {
                            continue;
                        }

                        var reader = new FileReader();

                        reader.onload = function (event) {
                            // POST Image to server
                            postMedia.headers = {};
                            postMedia.headers[customheader] = JSON.stringify(this.xFile);
                            postMedia.body = event.target.result;
                            postMedia.xFile = this.xFile;
                            postMedia.go();
                        };

                        reader.xFile = { type: file.type, name: file.name }
                        this.fire('fileUploading', reader.xFile);
                        reader.readAsDataURL(file);
                    }

                    return false;
                };
            },
            handleResponse: function (ev, res) {
                this.value = res.xhr.getResponseHeader("x-file-location");

                var xFile = JSON.parse(res.xhr.getResponseHeader(this.customheader));
                xFile.status = res.xhr.status;
                xFile.statusText = res.xhr.statusText;

                this.fire('fileUploaded', xFile);
            },
            handleError: function (ev, res) {
                var xFile = ev.srcElement.xFile;
                xFile.status = res.xhr.status;
                xFile.statusText = res.xhr.statusText;

                this.fire('fileUploadError', xFile);
            }
        });
    </script>
</polymer-element>
